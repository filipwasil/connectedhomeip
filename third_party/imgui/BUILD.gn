# Copyright (c) 2023 Project CHIP Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import("//build_overrides/build.gni")
import("//build_overrides/chip.gni")

if (current_os != "mac") {
  import("${build_root}/config/linux/pkg_config.gni")

  pkg_config("sdl2_pkgconfig") {
    packages = [ "sdl2" ]
  }
}

config("imgui_config") {
  include_dirs = [
    "repo",
    "repo/backends",
  ]
  defines = [ "CHIP_IMGUI_ENABLED=1" ]

  if (current_os == "mac") {
    # macOS: Use sdl2-config to get the right paths
    # This works for both Homebrew on Intel (/usr/local) and Apple Silicon (/opt/homebrew)
    sdl2_cflags =
        exec_script("${build_root}/config/linux/pkg-config.py",
                    [
                      "sdl2",
                      "--cflags",
                    ],
                    "string")

    # Parse the cflags string into a list
    cflags = []
    foreach(flag, string_split(sdl2_cflags)) {
      if (flag != "") {
        cflags += [ flag ]
      }
    }

    defines += [ "_THREAD_SAFE" ]
    ldflags = [
      "-framework",
      "OpenGL",
    ]
  } else {
    # Linux/other: Use pkg-config via the pkg_config template
    configs = [ ":sdl2_pkgconfig" ]
  }
}

source_set("imgui") {
  sources = [
    "repo/imconfig.h",
    "repo/imgui.cpp",
    "repo/imgui.h",
    "repo/imgui_draw.cpp",
    "repo/imgui_internal.h",
    "repo/imgui_tables.cpp",
    "repo/imgui_widgets.cpp",
    "repo/imstb_rectpack.h",
    "repo/imstb_textedit.h",
    "repo/imstb_truetype.h",
  ]

  # SDL2 + OPENGL3 backend enabled directly here since
  # the includes are circular (backend includes imgui)
  sources += [
    "repo/backends/imgui_impl_opengl3.cpp",
    "repo/backends/imgui_impl_opengl3.h",
    "repo/backends/imgui_impl_sdl2.cpp",
    "repo/backends/imgui_impl_sdl2.h",
  ]

  # SDL2 libs from pkg-config
  if (current_os == "mac") {
    sdl2_libs = exec_script("${build_root}/config/linux/pkg-config.py",
                            [
                              "sdl2",
                              "--libs",
                            ],
                            "string")

    # Parse libs and lib_dirs from the output
    # Format: -L/path/to/lib -lSDL2 -Wl,-framework,Cocoa ...
    ldflags = []
    foreach(flag, string_split(sdl2_libs)) {
      if (flag != "") {
        ldflags += [ flag ]
      }
    }
  } else {
    libs = [
      "SDL2",
      "dl",
    ]

    if (current_os == "linux") {
      libs += [ "GL" ]
    }
  }

  public_configs = [ ":imgui_config" ]
}
